name: doc_doxygen
on:
  push:
    branches:
      - 'doc-page'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: doxygen_doc generate
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶æ—¶é—´
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0
      
      - name: Install Tools
        shell: bash
        run: |
          # ä½¿ç”¨é»˜è®¤æºå®‰è£…å·¥å…·
          sudo apt-get update
          sudo apt-get -qq install doxygen graphviz zip
          # éªŒè¯å®‰è£…
          doxygen --version
          dot -V
      
      - name: Set Environment Variables
        shell: bash
        run: |
          # è®¾ç½®æ—¶åŒºä¸º UTC+8
          export TZ='Asia/Shanghai'
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
          
          echo "BUILD_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')" >> $GITHUB_ENV
          echo "BUILD_TIME=$(TZ='Asia/Shanghai' date +'%H%M%S')" >> $GITHUB_ENV
          echo "BUILD_DATETIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          # å¦‚æœæ˜¯æ ‡ç­¾è§¦å‘åˆ™æå–ç‰ˆæœ¬å·
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "VERSION=${VERSION/v/}" >> $GITHUB_ENV
          else
            # ä½¿ç”¨æ—¶é—´æˆ³é¿å…æ ‡ç­¾é‡å¤
            echo "VERSION=nightly-$(TZ='Asia/Shanghai' date +'%Y%m%d')" >> $GITHUB_ENV
          fi
          echo "VERSION: ${{ env.VERSION }}"
          echo "BUILD_DATE: ${{ env.BUILD_DATE }}"
          echo "BUILD_TIME: ${{ env.BUILD_TIME }}"
          echo "SHORT_SHA: ${{ env.SHORT_SHA }}"

      - name: Generate Doxygen HTML
        shell: bash
        run: |
          cd documentation
          echo "Starting Doxygen generation..."
          
          # å¤‡ä»½åŸå§‹ Doxyfile
          cp Doxyfile Doxyfile.backup
          
          # ä¼˜åŒ– Doxygen é…ç½®
          sed -i 's/PLANTUML_JAR_PATH.*/PLANTUML_JAR_PATH = /' Doxyfile
          sed -i 's/HAVE_DOT.*/HAVE_DOT = NO/' Doxyfile
          sed -i 's/GENERATE_HTMLHELP.*/GENERATE_HTMLHELP = NO/' Doxyfile
          sed -i 's/GENERATE_LATEX.*/GENERATE_LATEX = NO/' Doxyfile
          sed -i 's/GENERATE_RTF.*/GENERATE_RTF = NO/' Doxyfile
          sed -i 's/GENERATE_MAN.*/GENERATE_MAN = NO/' Doxyfile
          sed -i 's/GENERATE_XML.*/GENERATE_XML = NO/' Doxyfile
          sed -i 's/GENERATE_DOCBOOK.*/GENERATE_DOCBOOK = NO/' Doxyfile
          
          # æ€§èƒ½ä¼˜åŒ–è®¾ç½®
          sed -i 's/OPTIMIZE_OUTPUT_FOR_C.*/OPTIMIZE_OUTPUT_FOR_C = YES/' Doxyfile
          sed -i 's/BUILTIN_STL_SUPPORT.*/BUILTIN_STL_SUPPORT = YES/' Doxyfile
          sed -i 's/CPP_CLI_SUPPORT.*/CPP_CLI_SUPPORT = YES/' Doxyfile
          
          echo "Doxyfile configured, starting generation..."
          if ! doxygen Doxyfile; then
            echo "Doxygen failed, but workflow will continue."
            echo "Restoring original Doxyfile..."
            cp Doxyfile.backup Doxyfile
          fi
          
          # æ£€æŸ¥ç”Ÿæˆç»“æœ
          if [ -d "html" ]; then
            echo "âœ… HTML documentation generated successfully."
          else
            echo "âŒ Warning: HTML directory not found."
            echo "Restoring original Doxyfile and retrying..."
            cp Doxyfile.backup Doxyfile
            doxygen Doxyfile || echo "Retry also failed"
          fi
      
      - name: Package Documentation
        shell: bash
        run: |
          cd documentation
          if [ -d "html" ]; then
            echo "Creating documentation package..."
            zip -r ../doxygen-html.zip html
            echo "âœ… Documentation package created: doxygen-html.zip"
          else
            echo "âŒ Error: HTML directory not found, cannot create package."
            exit 1
          fi
      
      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: "Release ${{ env.VERSION }} (${{ env.BUILD_DATE }})"
          body: |
            ## RT-Thread RTOS Documentation
            
            è‡ªåŠ¨å‘å¸ƒäº ${{ env.BUILD_DATETIME }}
            Commit: [${{ env.SHORT_SHA }}](/commit/${{ github.sha }})
            
            ### ğŸ“¦ åŒ…å«å†…å®¹
            - å®Œæ•´çš„ API æ–‡æ¡£
            - HTML æ ¼å¼ï¼Œæ”¯æŒæœç´¢å’Œå¯¼èˆª
            - é€‚ç”¨äºç¦»çº¿æŸ¥çœ‹
            
            ### ğŸ”§ ç”Ÿæˆä¿¡æ¯
            - æ„å»ºæ—¶é—´: ${{ env.BUILD_DATETIME }}
            - æäº¤å“ˆå¸Œ: ${{ env.SHORT_SHA }}
            - åˆ†æ”¯: ${{ github.ref_name }}
          files: doxygen-html.zip
          prerelease: ${{ contains(env.VERSION, 'nightly') }}
          draft: false