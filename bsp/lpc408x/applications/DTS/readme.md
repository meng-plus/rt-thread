# 测温主机通信方案

## 简要

测温主机设备一共16条测温线路，每个线路需要接入15km长度光纤，测量精度为1m,响应速度要求1s,采用modbus-RTC协议收发控制，根据当前需求情况，设备有两个工作方式（分区模式/米点模式），但是后者每隔1m一条数据都需要采集到，数据量巨大，所以需要采用分区模式降低数据量，

数据量对比关系：

| 类别                  | 分区模式                        | 米点模式                  |
| --------------------- | ------------------------------- | ------------------------- |
| 通道数量              | 16通道                          | 16通道                    |
| 数据量对比            | 150分区 x 6 x 2Byte  ≈1.8kb数据 | 15000m x 2Byte≈30kB数据量 |
| 单通道最快传输用时(s) | 0.16s                           | 2.7s                      |
| 总用时(s)             | 2.6s                            | 43s                       |

## 分区模式测试结果

  测试环境

1. win10台式机
2. sscom V5.13.1 
3. 分布式光纤测温模块 

modbus通信有长度显示 03命令最多一次读取125(7D)个寄存器，根据测试软件日志来看，回应周期间隔4ms

```bash
[10:34:01.813]发→◇22 03 00 C8 00 7E 43 47 □
[10:34:05.925]发→◇22 03 00 C8 00 7D 03 46 □
[10:34:05.928]收←◆22 03 FA 00 00 00 00 00 00 58 12 00 04 45 AC 00 00 00 00 00 00 00 00 00 00 58 23 00 06 58 19 00 00 00 00 00 00 00 00 00 00 58 19 00 0B 58 12 00 00 00 00 00 00 00 00 00 00 58 09 00 10 58 05 00 00 00 00 00 00 00 00 00 00 58 13 00 18 58 09 00 00 00 00 00 00 00 00 00 00 58 11 00 1A 58 0D 00 00 00 00 00 00 00 00 00 00 58 12 00 22 58 0D 00 00 00 00 00 00 00 00 00 00 58 09 00 24 58 01 00 00 00 00 00 00 00 00 00 00 58 02 00 29 57 FD 00 00 00 00 00 00 00 00 00 00 58 06 00 2E 57 FE 00 00 00 00 00 00 00 00 00 00 57 FD 00 36 57 FB 00 00 00 00 00 00 00 00 00 00 58 00 00 3B 57 FB 00 00 00 00 00 00 00 00 00 00 58 20 00 40 58 18 00 00 00 00 00 00 00 00 00 00 58 26 00 43 58 20 00 00 00 00 00 00 00 00 00 00 58 1C 00 49 58 17 00 00 00 00 00 00 00 00 00 00 58 25 00 4D 76 5D 
[10:56:35.654]发→◇22 03 00 C8 00 0A 43 60 □
[10:56:35.655]收←◆22 03 14 00 00 00 00 00 00 57 55 00 04 45 34 00 00 00 00 00 00 00 00 96 6C 
```

根据厂家数据可知如下耗时情况

|                    | 分区模式 |      |
| ------------------ | -------- | ---- |
| 每分区地址数量     | 8        |      |
| 分区数量           | 125      |      |
| 通道数量           | 16       |      |
| 读取次数           | 8        |      |
| 读取间隔耗时(ms)   | 4        |      |
| 单通道间隔耗时(ms) | 32       |      |
| 16通道间隔耗时(ms) | 512ms    |      |

即对比理论速度，还要增加512ms的等待耗时，实际扫描一遍的速度应在3s以上。



### 设计规划

程序流程

```flow
sta=>start: 开始
e=>end: 结束
op=>operation: 加载配置数据：
1. 系统数据[01,02]
2. 通道数据[21,28]x16
op_CFG=>operation: 加载工作模式
op_READ=>operation: 遍历所有可用通道
op_READ_ONE=>operation: 读取指定通道
sub=>subroutine: 通信异常检测
cond=>condition: 通信异常
cond_CFG=>condition: 指定通道模式？
io=>inputoutput: 输出

sta->op(bottom)->cond->op_READ
cond(yes,left)->op
cond(no,bottom)->op_CFG->cond_CFG
cond_CFG(no,left)->op_READ->e
cond_CFG(yes)->op_READ_ONE->e
```



